<Window x:Class="WPF_WMS01.Views.Popups.InOutLedgerView"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:WPF_WMS01.Views.Popups"
        mc:Ignorable="d"
        Title="입/출고 원장 조회" 
        Height="650" Width="1000"
        WindowStartupLocation="CenterScreen"
        ResizeMode="CanResize">

    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="43.04"/>
            <RowDefinition Height="49.92"/>
            <!-- 검색 및 필터 영역 -->
            <RowDefinition Height="*"/>
            <!-- 데이터 그리드 영역 -->
            <RowDefinition Height="Auto"/>
            <!-- 상태 표시 -->
            <RowDefinition Height="Auto"/>
            <!-- 버튼 영역 -->
        </Grid.RowDefinitions>

        <!-- =================================================================== -->
        <!-- 1. 검색 필터 영역 -->
        <!-- =================================================================== -->
        <Border Grid.Row="0" BorderBrush="#CCCCCC" BorderThickness="0,0,0,1" Padding="15" Background="#F9F9F9" Margin="0,0,0,462" Grid.RowSpan="3">
            <StackPanel Orientation="Vertical">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="200"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="10"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- 1행: LOT 번호 및 현재 재고 필터 -->
                    <TextBlock Grid.Row="0" Grid.Column="0" Text="LOT 번호:" Margin="0,0,10,0" VerticalAlignment="Center"/>
                    <TextBox Grid.Row="0" Grid.Column="1" Text="{Binding SearchLotNumber, UpdateSourceTrigger=PropertyChanged}" Padding="5"/>

                    <CheckBox Grid.Row="0" Grid.Column="3" Content="현재 재고만 보기 (미출고)" IsChecked="{Binding ShowOnlyCurrentStock}" 
                              VerticalAlignment="Center" Margin="30,0,0,0" FontSize="14" Foreground="#007ACC"/>

                    <Button Grid.Row="0" Grid.Column="5" Content="조회" Command="{Binding SearchCommand}" Padding="10,5" Margin="50,0,0,0"
                            Background="#007ACC" Foreground="White" FontWeight="Bold" Cursor="Hand">
                        <Button.Style>
                            <Style TargetType="Button">
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="Button">
                                            <Border CornerRadius="5" Background="{TemplateBinding Background}" BorderBrush="{TemplateBinding BorderBrush}" BorderThickness="{TemplateBinding BorderThickness}">
                                                <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                            </Border>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                                <Style.Triggers>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter Property="Background" Value="#005A9E"/>
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </Button.Style>
                    </Button>

                    <!-- 2행: 입고 기간 필터 -->
                    <TextBlock Grid.Row="2" Grid.Column="0" Text="입고 기간:" Margin="0,0,10,0" VerticalAlignment="Center"/>
                    <DatePicker Grid.Row="2" Grid.Column="1" SelectedDate="{Binding InboundStart}" Margin="0,0,5,0"/>
                    <TextBlock Grid.Row="2" Grid.Column="2" Text="~" Margin="0,0,5,0" VerticalAlignment="Center"/>
                    <DatePicker Grid.Row="2" Grid.Column="3" SelectedDate="{Binding InboundEnd}"/>

                    <!-- 3행: 출고 기간 필터 -->
                    <TextBlock Grid.Row="2" Grid.Column="4" Text="출고 기간:" Margin="30,0,10,0" VerticalAlignment="Center"
                               Visibility="{Binding ShowOnlyCurrentStock, Converter={StaticResource BooleanToVisibilityConverter}, ConverterParameter=Invert}"/>
                    <DatePicker Grid.Row="2" Grid.Column="5" SelectedDate="{Binding OutboundStart}" Margin="0,0,5,0"
                                Visibility="{Binding ShowOnlyCurrentStock, Converter={StaticResource BooleanToVisibilityConverter}, ConverterParameter=Invert}"/>
                    <TextBlock Grid.Row="2" Grid.Column="6" Text="~" Margin="0,0,5,0" VerticalAlignment="Center"
                               Visibility="{Binding ShowOnlyCurrentStock, Converter={StaticResource BooleanToVisibilityConverter}, ConverterParameter=Invert}"/>
                    <DatePicker Grid.Row="2" Grid.Column="7" SelectedDate="{Binding OutboundEnd}"
                                Visibility="{Binding ShowOnlyCurrentStock, Converter={StaticResource BooleanToVisibilityConverter}, ConverterParameter=Invert}"/>
                </Grid>
            </StackPanel>
        </Border>

        <!-- =================================================================== -->
        <!-- 2. 데이터 목록 (DataGrid) -->
        <!-- =================================================================== -->
        <DataGrid Grid.Row="2" ItemsSource="{Binding LedgerItems}" AutoGenerateColumns="False" IsReadOnly="True"
                  Margin="15,10,15,10" Style="{DynamicResource DataGridStyle}">
            <DataGrid.Columns>
                <!-- 'IsSortable="False"' 속성을 제거했습니다. -->
                <DataGridTextColumn Header="ID" Binding="{Binding Id}" Width="Auto"/>
                <DataGridTextColumn Header="랙 이름" Binding="{Binding RackName}" Width="*"/>
                <DataGridTextColumn Header="LOT 번호" Binding="{Binding LotNumber}" Width="2*"/>
                <DataGridTextColumn Header="총알 유형" Binding="{Binding BulletType}" Width="*"/>
                <DataGridTextColumn Header="박스 수" Binding="{Binding BoxCount}" Width="*"/>
                <DataGridTextColumn Header="입고 시간" Binding="{Binding InboundAt, StringFormat='yyyy-MM-dd HH:mm:ss'}" Width="2*"/>
                <DataGridTextColumn Header="출고 시간" Binding="{Binding OutboundAt, StringFormat='yyyy-MM-dd HH:mm:ss'}" Width="2*"/>
                <DataGridTextColumn Header="상태" Binding="{Binding TypeDisplay}" Width="1.5*">
                    <DataGridTextColumn.ElementStyle>
                        <Style TargetType="TextBlock">
                            <Setter Property="FontWeight" Value="Bold"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding TypeDisplay}" Value="입고 (현재 재고)">
                                    <Setter Property="Foreground" Value="#28A745"/>
                                    <!-- Green -->
                                </DataTrigger>
                                <DataTrigger Binding="{Binding TypeDisplay}" Value="출고 완료">
                                    <Setter Property="Foreground" Value="#DC3545"/>
                                    <!-- Red -->
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </DataGridTextColumn.ElementStyle>
                </DataGridTextColumn>
            </DataGrid.Columns>
        </DataGrid>
        <!-- =================================================================== -->
        <!-- 3. 상태 표시/로딩 인디케이터 -->
        <!-- =================================================================== -->
        <Grid Grid.Row="2" Margin="15,462,15,15" Grid.RowSpan="2">
            <TextBlock HorizontalAlignment="Left" VerticalAlignment="Center" Foreground="#6C757D"
                       Text="{Binding LedgerItems.Count, StringFormat='총 {0}건 조회됨'}"/>

            <ProgressBar IsIndeterminate="True" Height="10" Width="100" HorizontalAlignment="Right" 
                         Visibility="{Binding IsBusy, Converter={StaticResource BooleanToVisibilityConverter}}"/>
        </Grid>

        <!-- 3. 버튼 영역 -->
        <StackPanel Grid.Row="3" Orientation="Horizontal" HorizontalAlignment="Left" Margin="828,31,0,0" Grid.RowSpan="2">
            <Button Content="CSV 내보내기" Command="{Binding ExportToCsvCommand}" Padding="10,5" Margin="0,0,10,0"/>
            <Button Content="닫기" IsCancel="True" Click="CloseButton_Click" Padding="10,5"/>
        </StackPanel>
        <DataGrid Grid.Row="2" ItemsSource="{Binding LedgerItems}" AutoGenerateColumns="False" IsReadOnly="True"
            Margin="15,10,15,10" Style="{DynamicResource DataGridStyle}">
            <DataGrid.Columns>
                <!-- 'IsSortable="False"' 속성을 제거했습니다. -->
                <DataGridTextColumn Header="ID" Binding="{Binding Id}" Width="Auto"/>
                <DataGridTextColumn Header="랙 이름" Binding="{Binding RackName}" Width="*"/>
                <DataGridTextColumn Header="LOT 번호" Binding="{Binding LotNumber}" Width="2*"/>
                <DataGridTextColumn Header="총알 유형" Binding="{Binding BulletType}" Width="*"/>
                <DataGridTextColumn Header="박스 수" Binding="{Binding BoxCount}" Width="*"/>
                <DataGridTextColumn Header="입고 시간" Binding="{Binding InboundAt, StringFormat=yyyy-MM-dd HH:mm:ss}" Width="2*"/>
                <DataGridTextColumn Header="출고 시간" Binding="{Binding OutboundAt, StringFormat=yyyy-MM-dd HH:mm:ss}" Width="2*"/>
                <DataGridTextColumn Header="상태" Binding="{Binding TypeDisplay}" Width="1.5*">
                    <DataGridTextColumn.ElementStyle>
                        <Style TargetType="{x:Type TextBlock}">
                            <Setter Property="FontWeight" Value="Bold"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding TypeDisplay}" Value="입고 (현재 재고)">
                                    <Setter Property="Foreground" Value="#28A745"/>
                                    <!-- Green -->
                                </DataTrigger>
                                <DataTrigger Binding="{Binding TypeDisplay}" Value="출고 완료">
                                    <Setter Property="Foreground" Value="#DC3545"/>
                                    <!-- Red -->
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </DataGridTextColumn.ElementStyle>
                </DataGridTextColumn>
            </DataGrid.Columns>
        </DataGrid>
    </Grid>

    <Window.Resources>
        <!-- Invert BooleanToVisibilityConverter for 'ShowOnlyCurrentStock' -->
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>

        <!-- 필요한 기본 스타일 (WPF 프로젝트의 App.xaml에 있을 수 있지만, 여기에 간단히 추가) -->
        <Style TargetType="{x:Type DataGrid}" x:Key="DataGridStyle">
            <Setter Property="GridLinesVisibility" Value="Horizontal"/>
            <Setter Property="HeadersVisibility" Value="Column"/>
            <Setter Property="BorderBrush" Value="#CCCCCC"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="RowBackground" Value="White"/>
            <Setter Property="AlternatingRowBackground" Value="#F8F8F8"/>
            <Setter Property="SelectionMode" Value="Single"/>
            <Setter Property="CanUserAddRows" Value="False"/>
            <Setter Property="CanUserDeleteRows" Value="False"/>
        </Style>
    </Window.Resources>
</Window>
